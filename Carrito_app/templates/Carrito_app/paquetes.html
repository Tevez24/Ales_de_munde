{% extends 'Carrito_app/base.html' %}
{% load static %}

{% block title %}Explora Paquetes de Viaje | Ailes du Monde{% endblock %}

{% block content %}

<!-- =================================== HERO SECTION =================================== -->
<div class="bg-gray-50">
  <div class="relative h-screen bg-cover bg-center" style="background-image: url('{% static 'Carrito_app/media/img/paquete1.jpg' %}');">
    <!-- Overlay oscuro -->
    <div class="absolute inset-0 bg-black opacity-60"></div>

    <!-- Contenido del Hero -->
    <div class="relative container mx-auto px-6 h-full flex flex-col justify-center items-center text-center text-white z-10">
      <h1 class="text-5xl md:text-6xl font-extrabold mb-6 tracking-tight animate-fadeIn">
        Encuentra tu Próxima Aventura
      </h1>
      <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto font-light animate-fadeIn" style="animation-delay: 0.5s;">
        Paquetes de viaje diseñados para cada tipo de explorador. Personalizados, sostenibles y llenos de experiencias únicas.
      </p>

      <div class="flex flex-col md:flex-row justify-center gap-4 md:gap-6 animate-fadeIn" style="animation-delay: 1s;">
        <a href="{% url 'contacto' %}" 
           class="border-2 border-white text-white px-8 py-4 rounded-full font-semibold hover:bg-white hover:text-blue-700 transition-all transform hover:scale-105"
           aria-label="Solicitar asesoría personalizada">
          Asesoría Personalizada
        </a>
      </div>
    </div>
  </div>

  <!-- =================================== MAIN CONTENT: FILTROS + PAQUETES =================================== -->
  <div class="container mx-auto px-6 py-20" id="paquetes">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

      <!-- =================================== SIDEBAR: FILTROS =================================== -->
      <aside class="lg:col-span-1">
        <div class="bg-white p-6 rounded-2xl shadow-lg sticky top-24 border border-gray-100">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i data-lucide="filter" class="h-6 w-6 mr-2 text-blue-600"></i> Filtrar Paquetes
          </h2>

          <form method="GET" action="{% url 'paquetes' %}" class="space-y-6">
            {% csrf_token %}

            <!-- Filtro: Destino -->
            <div>
              <label for="destino" class="block text-sm font-medium text-gray-700 mb-2">Destino</label>
              <select name="destino" id="destino" 
                      class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 py-3 px-4 text-gray-700">
                <option value="">Todos los Destinos</option>
                {% for d in destinos %}
                  <option value="{{ d.id }}" {% if request.GET.destino == d.id|stringformat:"s" %}selected{% endif %}>
                    {{ d.nombre }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Filtro: Tipo -->
            <div>
              <label for="tipo" class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
              <select name="tipo" id="tipo" 
                      class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 py-3 px-4 text-gray-700">
                <option value="">Todos</option>
                <option value="NACIONAL" {% if request.GET.tipo == 'NACIONAL' %}selected{% endif %}>Nacional</option>
                <option value="INTERNACIONAL" {% if request.GET.tipo == 'INTERNACIONAL' %}selected{% endif %}>Internacional</option>
              </select>
            </div>

            <!-- Filtro: Precio Máximo -->
            <div>
              <label for="precio_max" class="block text-sm font-medium text-gray-700 mb-2">Precio Máximo</label>
              <input type="range" 
                     id="precio_max" 
                     name="precio_max" 
                     min="500" 
                     max="5000" 
                     step="100"
                     value="{{ request.GET.precio_max|default:'10000' }}"
                     class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
              <div class="text-center text-gray-600 mt-2 font-semibold">
                $ <span id="precio-max-valor">{{ request.GET.precio_max|default:'10000' }}</span>
              </div>
            </div>

            <!-- Botón Aplicar -->
            <button type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-all transform hover:scale-105">
              Aplicar Filtros
            </button>
          </form>
        </div>
      </aside>
      <!-- FIN FILTROS -->

      <!-- =================================== MAIN: LISTADO DE PAQUETES =================================== -->
      <main class="lg:col-span-3">
        <!-- Contador de resultados -->
        <div class="mb-8 flex justify-between items-center">
          <p class="text-gray-600">
            Mostrando <strong>{% if paquetes %}{{ paquetes|length }}{% else %}0{% endif %}</strong> 
            paquete{{ paquetes|length|pluralize }} disponible{{ paquetes|length|pluralize }}
          </p>
        </div>

        <!-- Grid de paquetes -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
          {% if paquetes %}
            {% for paquete in paquetes %}
              <article class="bg-white rounded-2xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-all duration-300 flex flex-col border-2 
                              {% if paquete.oferta %}border-red-500{% else %}border-gray-100{% endif %} animate-fadeInCard">
                
                <!-- Imagen -->
                <div class="relative">
                  <img src="{% if paquete.imagen %}{{ paquete.imagen.url }}{% else %}https://images.unsplash.com/photo-1501785882288-1e2a1b0b2b2e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80{% endif %}"
                       alt="Imagen de {{ paquete.nombre }}" 
                       class="w-full h-56 object-cover">
                  
                  <div class="absolute top-4 left-4 flex flex-wrap items-center gap-2">
                    <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-semibold">{{ paquete.categoria }}</span>
                    <span class="bg-white text-gray-700 px-2 py-1 rounded-full text-xs border border-gray-200 flex items-center gap-1">
                      <i data-lucide="globe" class="h-3 w-3 text-gray-600"></i> {{ paquete.tipo }}
                    </span>
                  </div>
                </div>

                <!-- Contenido -->
                <div class="p-6 flex flex-col flex-grow">
                  <header class="mb-2">
                    <h3 class="text-2xl font-semibold text-gray-800 flex items-center justify-between">
                      <span class="flex items-center">
                        <i data-lucide="package" class="h-5 w-5 mr-2 text-blue-600"></i> {{ paquete.nombre }}
                      </span>
                      <span class="flex items-center text-sm text-gray-600 gap-4">
                        {% if paquete.rating %}
                          <span class="flex items-center gap-1">
                            <i data-lucide="star" class="h-4 w-4 text-yellow-400"></i> 
                            {{ paquete.rating }} <small class="text-gray-500">({{ paquete.reseñas_count }})</small>
                          </span>
                        {% endif %}
                        <span class="flex items-center gap-1">
                          <i data-lucide="calendar" class="h-4 w-4"></i> {{ paquete.duracion }} días
                        </span>
                      </span>
                    </h3>
                  </header>

                  <p class="text-gray-600 mb-4 flex items-center">
                    <i data-lucide="map-pin" class="h-5 w-5 mr-2 text-green-500"></i>
                    <strong>{{ paquete.destino }}</strong>
                  </p>

                  <!-- Incluye o descripción -->
                  {% if paquete.incluye %}
                    <ul class="mb-4 space-y-2 text-gray-700">
                      {% for item in paquete.incluye|slice:":3" %}
                        <li class="flex items-start gap-3">
                          <span class="h-2 w-2 bg-green-400 rounded-full mt-2 flex-shrink-0"></span>
                          <span>{{ item }}</span>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-gray-700 flex-grow mb-4">{{ paquete.descripcion|truncatewords:25 }}</p>
                  {% endif %}

                  <!-- Precio y acciones -->
                  <footer class="mt-auto pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                      <p class="text-3xl font-bold text-blue-600">${{ paquete.precio|floatformat:2 }}</p>
                      {% if paquete.oferta %}
                        <span class="bg-red-500 text-white text-sm font-semibold px-3 py-1 rounded-full animate-pulse">
                          EN OFERTA
                        </span>
                      {% endif %}
                    </div>

                    <div class="flex space-x-3">
                      <a href="{% url 'paquete_detalle' paquete.id %}" 
                         class="flex-1 text-center bg-blue-100 text-blue-700 hover:bg-blue-200 font-semibold px-4 py-3 rounded-lg transition-all">
                        Ver Detalles
                      </a>
                      <button onclick="addToCart('paquete', {{ paquete.id }})"
                              class="flex-1 text-center bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-3 rounded-lg transition-all flex items-center justify-center">
                        <i data-lucide="shopping-cart" class="h-5 w-5 mr-2"></i> Reservar
                      </button>
                    </div>
                  </footer>
                </div>
              </article>
            {% endfor %}

          {% else %}
            <!-- Sin resultados -->
            <div class="col-span-full text-center py-16 bg-white rounded-2xl shadow-lg">
              <i data-lucide="search-x" class="h-20 w-20 text-gray-400 mx-auto mb-6"></i>
              <h3 class="text-2xl font-semibold text-gray-700 mb-2">No se encontraron paquetes</h3>
              <p class="text-gray-500 mb-6">Intenta ajustar tus filtros o revisa nuestros destinos nuevamente.</p>
              <a href="{% url 'paquetes' %}" 
                 class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all inline-flex items-center gap-2">
                <i data-lucide="rotate-cw" class="h-5 w-5"></i> Reiniciar Filtros
              </a>
            </div>
          {% endif %}
        </div>

        <!-- =================================== PAGINACIÓN =================================== -->
        {% if paquetes.has_other_pages %}
          <nav class="mt-12 flex justify-center items-center space-x-2" aria-label="Paginación">
            {% if paquetes.has_previous %}
              <a href="?page={{ paquetes.previous_page_number }}{% if request.GET.destino %}&destino={{ request.GET.destino }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.precio_max %}&precio_max={{ request.GET.precio_max }}{% endif %}" 
                 class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all">
                Anterior
              </a>
            {% endif %}

            <span class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium">
              Página {{ paquetes.number }} de {{ paquetes.paginator.num_pages }}
            </span>

            {% if paquetes.has_next %}
              <a href="?page={{ paquetes.next_page_number }}{% if request.GET.destino %}&destino={{ request.GET.destino }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.precio_max %}&precio_max={{ request.GET.precio_max }}{% endif %}" 
                 class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all">
                Siguiente
              </a>
            {% endif %}
          </nav>
        {% endif %}
      </main>
      <!-- FIN MAIN -->
    </div>
  </div>
</div>
<!-- FIN CONTENEDOR PRINCIPAL -->

{% endblock %}


<!-- =================================== SCRIPTS Y ESTILOS =================================== -->
{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // === Actualizar valor del slider de precio ===
    const precioMaxInput = document.getElementById('precio_max');
    const precioMaxValor = document.getElementById('precio-max-valor');
    if (precioMaxInput && precioMaxValor) {
      precioMaxInput.addEventListener('input', function () {
        precioMaxValor.textContent = this.value;
      });
      // Inicializar valor
      precioMaxValor.textContent = precioMaxInput.value;
    }

    // === Inicializar íconos Lucide ===
    if (window.lucide && typeof lucide.createIcons === 'function') {
      lucide.createIcons().catch(err => console.error('Error Lucide:', err));
    }
  });

  // === Obtener CSRF Token ===
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // === Añadir al carrito (AJAX) ===
  async function addToCart(productType, itemId) {
    const csrftoken = getCookie('csrftoken');
    try {
      const response = await fetch(`/add_to_cart/${productType}/${itemId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ product_type: productType, item_id: itemId })
      });

      const data = await response.json();
      if (response.ok && data.status === 'success') {
        alert('¡Paquete añadido al carrito!');
        window.dispatchEvent(new CustomEvent('cart-updated'));
      } else {
        alert(data.message || 'Error al añadir al carrito');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error de conexión. Intenta de nuevo.');
    }
  }
</script>
{% endblock %}


{% block extra_css %}
<style>
  .animate-fadeIn {
    animation: fadeIn 1.5s ease-out forwards;
    opacity: 0;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-fadeInCard {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInCard 0.8s ease-out forwards;
  }
  @keyframes fadeInCard {
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-pulse {
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #2563eb;
    cursor: pointer;
    box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.3);
    transition: all 0.2s;
  }
  input[type="range"]::-webkit-slider-thumb:hover {
    box-shadow: 0 0 0 8px rgba(37, 99, 235, 0.2);
  }
</style>
{% endblock %}